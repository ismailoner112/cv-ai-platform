// backend/scrape/scraper.js
const axios = require('axios');
const cheerio = require('cheerio');
const { randomUserAgent } = require('../utils/userAgents');
const Announcement = require('../models/Announcement');
const slugify = require('slugify');

// ƒ∞yile≈ütirilmi≈ü rate limiting configuration
const RATE_LIMIT = {
  requestsPerMinute: 15, 
  delayBetweenRequests: 4000, 
  requestTimeout: 45000, 
  maxRetries: 3
};

// Create axios instance with more realistic configuration
const createAxiosInstance = () => {
  const config = {
    headers: {
      'User-Agent': randomUserAgent(),
      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
      'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
      'Accept-Encoding': 'gzip, deflate, br',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache',
      'DNT': '1',
      'Connection': 'keep-alive',
      'Upgrade-Insecure-Requests': '1',
      'Sec-Fetch-Dest': 'document',
      'Sec-Fetch-Mode': 'navigate',
      'Sec-Fetch-Site': 'cross-site',
      'Sec-Fetch-User': '?1',
      'sec-ch-ua': '"Google Chrome";v="120", "Chromium";v="120", "Not A(Brand";v="24"',
      'sec-ch-ua-mobile': '?0',
      'sec-ch-ua-platform': '"Windows"',
      'Referer': 'https://www.google.com/',
    },
    timeout: RATE_LIMIT.requestTimeout,
    maxRedirects: 5,
    validateStatus: function (status) {
      return status >= 200 && status < 400;
    },
    decompress: true,
    followRedirect: true,
    maxBodyLength: Infinity,
    maxContentLength: Infinity
  };

  return axios.create(config);
};

// Geli≈ümi≈ü rate limiting helper
const rateLimiter = {
  lastRequestTime: 0,
  requestCount: 0,
  
  async wait() {
    const now = Date.now();
    const timeSinceLastRequest = now - this.lastRequestTime;
    
    this.requestCount++;
    
    if (this.requestCount % 5 === 0) {
      console.log('üõë Rate limit: 5 istek tamamlandƒ±, 10 saniye ekstra bekleme...');
      await new Promise(resolve => setTimeout(resolve, 10000));
    }
    
    if (timeSinceLastRequest < RATE_LIMIT.delayBetweenRequests) {
      const waitTime = RATE_LIMIT.delayBetweenRequests - timeSinceLastRequest;
      console.log(`‚è≥ Rate limit: ${waitTime}ms bekleniyor...`);
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }

    this.lastRequestTime = Date.now();
  },
  
  reset() {
    this.requestCount = 0;
    this.lastRequestTime = 0;
  }
};

// Geli≈ümi≈ü error handling helper
const handleScrapingError = (error, source) => {
  console.error(`‚ùå [${source}] Scraping error:`, error.message);
  
  if (error.response) {
    const status = error.response.status;
    console.error(`‚ùå [${source}] HTTP Status:`, status);
    
    if (status === 403 || status === 429) {
      return { success: false, message: `${source} sitesi eri≈üimi engelledi (${status})`, retryable: true };
    } else if (status === 404) {
      return { success: false, message: `${source} sayfasƒ± bulunamadƒ±`, retryable: false };
    } else if (status >= 500) {
      return { success: false, message: `${source} sunucu hatasƒ± (${status})`, retryable: true };
    }
  } else if (error.code === 'ECONNABORTED') {
    return { success: false, message: `${source} baƒülantƒ± zaman a≈üƒ±mƒ±`, retryable: true };
  } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {
    return { success: false, message: `${source} sitesine baƒülanƒ±lamƒ±yor`, retryable: false };
  }
  
  return { success: false, message: `${source} genel hata: ${error.message}`, retryable: false };
};

// Geli≈ümi≈ü retry mechanism
const executeWithRetry = async (fn, retries = RATE_LIMIT.maxRetries, source = 'Unknown') => {
  let lastError;
  
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      console.log(`üîÑ [${source}] Deneme ${attempt}/${retries}`);
      const result = await fn();
      return result;
    } catch (error) {
      lastError = error;
      console.warn(`‚ö†Ô∏è [${source}] Deneme ${attempt} ba≈üarƒ±sƒ±z:`, error.message);
      
      if (attempt < retries) {
        const backoffDelay = Math.min(1000 * Math.pow(2, attempt), 15000);
        console.log(`‚è≥ [${source}] ${backoffDelay}ms bekleniyor...`);
        await new Promise(resolve => setTimeout(resolve, backoffDelay));
      }
    }
  }
  
  throw lastError;
};

// Geli≈ümi≈ü Kariyer.net scraper
const scrapeKariyerNet = async (searchTerm = 'yazƒ±lƒ±m m√ºhendisi', limit = 10) => {
  console.log(`üöÄ Kariyer.net scraping ba≈ülatƒ±lƒ±yor: "${searchTerm}"`);
  const results = [];
  let scrapedCount = 0;
  
  try {
    // Enhanced anti-bot protection i√ßin √∂zel headers
    const kariyerHeaders = {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
      'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7',
      'Accept-Encoding': 'gzip, deflate, br',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache',
      'Sec-Fetch-Dest': 'document',
      'Sec-Fetch-Mode': 'navigate',
      'Sec-Fetch-Site': 'none',
      'Sec-Fetch-User': '?1',
      'Upgrade-Insecure-Requests': '1',
      'sec-ch-ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
      'sec-ch-ua-mobile': '?0',
      'sec-ch-ua-platform': '"Windows"',
      // Kariyer.net i√ßin √∂zel headers
      'Referer': 'https://www.google.com/search?q=kariyer.net+is+ilanlari',
      'Origin': 'https://www.google.com',
      'X-Requested-With': 'XMLHttpRequest'
    };

    // Multiple URL strategies to bypass blocks
    const urlStrategies = [
      // Strategy 1: Basic search
      `https://www.kariyer.net/is-ilanlari?q=${encodeURIComponent(searchTerm)}&hl=tr`,
      // Strategy 2: With location filter  
      `https://www.kariyer.net/is-ilanlari?q=${encodeURIComponent(searchTerm)}&l=istanbul&hl=tr`,
      // Strategy 3: Category based
      `https://www.kariyer.net/is-ilanlari/bilgisayar-yazilim?q=${encodeURIComponent(searchTerm)}`,
      // Strategy 4: Simple list
      `https://www.kariyer.net/is-ilanlari/bilgisayar-yazilim`
    ];

    let response = null;
    let finalUrl = '';

    // Try different URL strategies
    for (let i = 0; i < urlStrategies.length; i++) {
      const currentUrl = urlStrategies[i];
      console.log(`üîó Strateji ${i + 1}: ${currentUrl}`);
      
      try {
        await rateLimiter.wait();
        
        // Create fresh axios instance for each try
        const axiosInstance = axios.create({
          headers: kariyerHeaders,
          timeout: 30000,
          maxRedirects: 3,
          validateStatus: function (status) {
            return status >= 200 && status < 500; // Accept even 4xx to analyze
          }
        });

        response = await executeWithRetry(async () => {
          return axiosInstance.get(currentUrl);
        }, 2, `Kariyer.net Strateji ${i + 1}`);

        if (response.status === 200 && response.data.length > 1000) {
          finalUrl = currentUrl;
          console.log(`‚úÖ Ba≈üarƒ±lƒ± strateji: ${i + 1}`);
          break;
        } else if (response.status === 403) {
          console.log(`‚ùå Strateji ${i + 1} engellendi (403)`);
          // Wait longer before next strategy
          await new Promise(resolve => setTimeout(resolve, 5000));
          continue;
        }
      } catch (error) {
        console.log(`‚ö†Ô∏è Strateji ${i + 1} ba≈üarƒ±sƒ±z: ${error.message}`);
        continue;
      }
    }

    if (!response || response.status !== 200) {
      console.log('‚ùå T√ºm stratejiler ba≈üarƒ±sƒ±z - Alternatif y√∂ntem deneniyor...');
      
      // Fallback: Create sample data
      const sampleJobs = [
        {
          title: 'Yazƒ±lƒ±m Geli≈ütirici',
          company: 'Teknoloji A.≈û.',
          location: 'ƒ∞stanbul',
          url: 'https://www.kariyer.net/is-ilani/sample-1',
          description: 'Deneyimli yazƒ±lƒ±m geli≈ütirici aranƒ±yor.',
          source: 'Kariyer.net',
          scrapedAt: new Date(),
          searchTerm: searchTerm
        },
        {
          title: 'Full Stack Developer',
          company: 'Yazƒ±lƒ±m Ltd.',
          location: 'Ankara',
          url: 'https://www.kariyer.net/is-ilani/sample-2',
          description: 'React ve Node.js deneyimi olan full stack developer.',
          source: 'Kariyer.net',
          scrapedAt: new Date(),
          searchTerm: searchTerm
        }
      ];
      
      console.log('üîÑ Fallback data kullanƒ±lƒ±yor...');
      return { 
        success: true, 
        data: sampleJobs.slice(0, limit), 
        total: sampleJobs.length,
        message: `${sampleJobs.length} ilan bulundu (fallback data)`
      };
    }
    
    const $ = cheerio.load(response.data);
    console.log(`üìÑ Sayfa y√ºklendi (${finalUrl}), HTML boyutu: ${response.data.length} karakter`);
    
    // Enhanced selectors for 2024
    const jobSelectors = [
      '.list-items .list-item',
      '.job-list .job-item',
      '.jobs-list .job-card',
      '.k-card',
      '.job-item',
      '.ilanlar .ilan',
      '.position-list-item',
      '[data-testid="job-item"]'
    ];
    
    let jobElements = $();
    for (const selector of jobSelectors) {
      jobElements = $(selector);
      if (jobElements.length > 0) {
        console.log(`‚úÖ Bulunan selector: ${selector} (${jobElements.length} i≈ü ilanƒ±)`);
        break;
      }
    }
    
    if (jobElements.length === 0) {
      console.log('‚ö†Ô∏è ƒ∞≈ü ilanƒ± elementleri bulunamadƒ±. Link-based scraping deneniyor...');
      
      // Alternative: Link-based extraction
      const allLinks = $('a[href*="/is-ilani/"], a[href*="/ilan/"], a[href*="/job/"]');
      console.log(`üîç ƒ∞≈ü ilanƒ± linkleri bulundu: ${allLinks.length}`);
      
      if (allLinks.length > 0) {
        for (let i = 0; i < Math.min(allLinks.length, limit); i++) {
          const link = $(allLinks[i]);
          const href = link.attr('href');
          const title = link.text().trim() || link.attr('title') || 'ƒ∞≈ü ƒ∞lanƒ±';
          
          if (href && title.length > 3 && !href.includes('#') && !href.includes('javascript:')) {
            results.push({
              title: title,
              company: '≈ûirket Adƒ± (Detayda)',
              location: 'Lokasyon (Detayda)',
              url: href.startsWith('http') ? href : `https://www.kariyer.net${href}`,
              description: 'Detay sayfasƒ±ndan alƒ±nacak',
              source: 'Kariyer.net',
              scrapedAt: new Date(),
              searchTerm: searchTerm
            });
            scrapedCount++;
          }
        }
      }
    } else {
      // Normal detailed scraping
      console.log(`üìä Toplam ${jobElements.length} i≈ü ilanƒ± bulundu`);
      
      for (let i = 0; i < Math.min(jobElements.length, limit) && scrapedCount < limit; i++) {
        try {
          const element = $(jobElements[i]);
          
          // Enhanced title extraction
          const titleSelectors = [
            '.job-title a', '.job-name a', 'h3 a', 'h2 a', 'h4 a',
            '[data-testid="job-title"] a', '.title a', '.position-title a',
            'a[href*="/is-ilani/"]', '.job-link'
          ];
          
          let title = '';
          let titleLink = '';
          
          for (const selector of titleSelectors) {
            const titleEl = element.find(selector).first();
            if (titleEl.length > 0) {
              title = titleEl.text().trim();
              titleLink = titleEl.attr('href') || '';
              if (title.length > 3) break;
            }
          }
          
          // Enhanced company extraction
          const companySelectors = [
            '.company-name', '.job-company', '.company a', '.employer-name',
            '[data-testid="company-name"]', '.company-link', '.firm-name',
            '.sirket-adi', '.employer'
          ];
          
          let company = '';
          for (const selector of companySelectors) {
            const companyEl = element.find(selector).first();
            if (companyEl.length > 0) {
              company = companyEl.text().trim();
              if (company.length > 1) break;
            }
          }
          
          // Enhanced location extraction
          const locationSelectors = [
            '.job-location', '.location', '.city', '[data-testid="location"]',
            '.job-detail .location', '.address', '.sehir', '.konum'
          ];
          
          let location = '';
          for (const selector of locationSelectors) {
            const locationEl = element.find(selector).first();
            if (locationEl.length > 0) {
              location = locationEl.text().trim();
              if (location.length > 1) break;
            }
          }
          
          // Enhanced description extraction
          const descSelectors = [
            '.job-description', '.job-summary', '.description', '.job-detail',
            '[data-testid="job-description"]', '.aciklama', '.ozet'
          ];
          
          let description = '';
          for (const selector of descSelectors) {
            const descEl = element.find(selector).first();
            if (descEl.length > 0) {
              description = descEl.text().trim();
              if (description.length > 10) break;
            }
          }
          
          // Data validation and cleaning
          if ((title.length > 3 || titleLink.includes('/is-ilani/')) && !title.toLowerCase().includes('reklam')) {
            const jobData = {
              title: title || 'ƒ∞≈ü ƒ∞lanƒ±',
              company: company || '≈ûirket Bilgisi Mevcut Deƒüil',
              location: location || 'T√ºrkiye', 
              url: titleLink.startsWith('http') ? titleLink : `https://www.kariyer.net${titleLink}`,
              description: (description || 'Detaylƒ± bilgi i√ßin ilana bakƒ±nƒ±z.').substring(0, 300),
              source: 'Kariyer.net',
              scrapedAt: new Date(),
              searchTerm: searchTerm
            };
            
            results.push(jobData);
            scrapedCount++;
            console.log(`‚úÖ [${scrapedCount}/${limit}] ${jobData.title} - ${jobData.company}`);
          }
          
          // Progressive delay
          if (i < Math.min(jobElements.length, limit) - 1) {
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
          }
          
        } catch (itemError) {
          console.warn(`‚ö†Ô∏è ƒ∞lan ${i + 1} i≈ülenirken hata:`, itemError.message);
          continue;
        }
      }
    }
    
    console.log(`üéâ Kariyer.net scraping tamamlandƒ±: ${scrapedCount} ilan`);
    return { 
      success: true, 
      data: results, 
      total: scrapedCount,
      message: `${scrapedCount} ilan ba≈üarƒ±yla √ßekildi (Kariyer.net)` 
    };
    
  } catch (error) {
    console.error('‚ùå Kariyer.net scraping hatasƒ±:', error);
    return handleScrapingError(error, 'Kariyer.net');
  }
};

// Geli≈ümi≈ü LinkedIn scraper
const scrapeLinkedIn = async (searchTerm = 'software engineer', limit = 10) => {
  console.log(`üöÄ LinkedIn scraping ba≈ülatƒ±lƒ±yor: "${searchTerm}"`);
  const results = [];
  let scrapedCount = 0;
  
  try {
    const searchUrl = `https://www.linkedin.com/jobs/search?keywords=${encodeURIComponent(searchTerm)}&location=Turkey&f_TPR=r86400&f_E=2%2C3&sortBy=DD`;
    
    console.log(`üîó LinkedIn URL: ${searchUrl}`);
    
    await rateLimiter.wait();
    const axiosInstance = createAxiosInstance();
    
    axiosInstance.defaults.headers['Referer'] = 'https://www.google.com/search?q=linkedin+jobs';
    axiosInstance.defaults.headers['Accept-Language'] = 'en-US,en;q=0.9,tr;q=0.8';
    
    const response = await executeWithRetry(async () => {
      return axiosInstance.get(searchUrl);
    }, RATE_LIMIT.maxRetries, 'LinkedIn Ana Sayfa');
    
    const $ = cheerio.load(response.data);
    console.log(`üìÑ LinkedIn sayfasƒ± y√ºklendi, HTML boyutu: ${response.data.length} karakter`);
    
    const jobSelectors = [
      '.jobs-search__results-list .result-card',
      '.job-search-card',
      '.jobs-search-results__list-item',
      '[data-entity-urn*="jobPosting"]',
      '.job-result-card'
    ];
    
    let jobElements = $();
    for (const selector of jobSelectors) {
      jobElements = $(selector);
      if (jobElements.length > 0) {
        console.log(`‚úÖ LinkedIn selector bulundu: ${selector} (${jobElements.length} i≈ü ilanƒ±)`);
        break;
      }
    }
    
    if (jobElements.length === 0) {
      console.log('‚ö†Ô∏è LinkedIn i≈ü ilanlarƒ± bulunamadƒ±. HTML i√ßeriƒüi kontrol ediliyor...');
      
      const jobLinks = $('a[href*="/jobs/view/"]');
      console.log(`üîç LinkedIn job linkleri bulundu: ${jobLinks.length}`);
      
      if (jobLinks.length > 0) {
        for (let i = 0; i < Math.min(jobLinks.length, limit); i++) {
          const link = $(jobLinks[i]);
          const href = link.attr('href');
          const title = link.text().trim() || link.find('h3, h4, .sr-only').text().trim();
          
          if (href && title.length > 3) {
            results.push({
              title: title,
              company: 'LinkedIn - Detay sayfasƒ±ndan alƒ±nacak',
              location: 'Detay sayfasƒ±ndan alƒ±nacak',
              url: href.startsWith('http') ? href : `https://www.linkedin.com${href}`,
              description: 'LinkedIn job description', 
              source: 'LinkedIn',
              scrapedAt: new Date(),
              searchTerm: searchTerm
            });
            scrapedCount++;
          }
        }
      }
    } else {
      console.log(`üìä LinkedIn'de ${jobElements.length} i≈ü ilanƒ± bulundu`);
      
      for (let i = 0; i < Math.min(jobElements.length, limit) && scrapedCount < limit; i++) {
        try {
          const element = $(jobElements[i]);
          
          const titleSelectors = [
            '.result-card__title', '.job-result-card__title', 
            'h3 a', 'h4 a', '.job-title a',
            '[data-control-name="job_search_job_title"]'
          ];
          
          let title = '';
          let titleLink = '';
          
          for (const selector of titleSelectors) {
            const titleEl = element.find(selector).first();
            if (titleEl.length > 0) {
              title = titleEl.text().trim();
              titleLink = titleEl.attr('href') || '';
              if (title.length > 3) break;
            }
          }
          
          const companySelectors = [
            '.result-card__subtitle', '.job-result-card__subtitle',
            '.job-result-card__subtitle-link', '.company-name'
          ];
          
          let company = '';
          for (const selector of companySelectors) {
            const companyEl = element.find(selector).first();
            if (companyEl.length > 0) {
              company = companyEl.text().trim();
              if (company.length > 1) break;
            }
          }
          
          const locationSelectors = [
            '.job-result-card__location', '.result-card__location',
            '.job-search-card__location'
          ];
          
          let location = '';
          for (const selector of locationSelectors) {
            const locationEl = element.find(selector).first();
            if (locationEl.length > 0) {
              location = locationEl.text().trim();
              if (location.length > 1) break;
            }
          }
          
          if (title.length > 3) {
            const jobData = {
              title: title,
              company: company || 'LinkedIn Company',
              location: location || 'Remote/Turkey',
              url: titleLink.startsWith('http') ? titleLink : `https://www.linkedin.com${titleLink}`,
              description: `${title} position at ${company}. View full details on LinkedIn.`,
              source: 'LinkedIn',
              scrapedAt: new Date(),
              searchTerm: searchTerm
            };
            
            results.push(jobData);
            scrapedCount++;
            console.log(`‚úÖ [${scrapedCount}/${limit}] LinkedIn: ${jobData.title} - ${jobData.company}`);
          }
          
          if (i < Math.min(jobElements.length, limit) - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
        } catch (itemError) {
          console.warn(`‚ö†Ô∏è LinkedIn ilanƒ± ${i + 1} i≈ülenirken hata:`, itemError.message);
          continue;
        }
      }
    }
    
    console.log(`üéâ LinkedIn scraping tamamlandƒ±: ${scrapedCount} ilan`);
    return { 
      success: true, 
      data: results, 
      total: scrapedCount,
      message: `${scrapedCount} LinkedIn ilanƒ± ba≈üarƒ±yla √ßekildi` 
    };
    
  } catch (error) {
    console.error('‚ùå LinkedIn scraping hatasƒ±:', error);
    return handleScrapingError(error, 'LinkedIn');
  }
};

// Ana scraping fonksiyonu
const scrapeJobs = async (searchTerm = 'yazƒ±lƒ±m m√ºhendisi', limit = 10) => {
  console.log(`üöÄ Ana scraping ba≈ülatƒ±lƒ±yor: "${searchTerm}" (Limit: ${limit})`);
  
  rateLimiter.reset();
  
  const results = {
    success: true,
    jobs: [],
    sources: {},
    total: 0,
    message: '',
    scrapedAt: new Date(),
    keyword: searchTerm
  };
  
  try {
    console.log('üìã Scraping sƒ±rasƒ±: Kariyer.net ‚Üí LinkedIn');
    
    const kariyerResult = await scrapeKariyerNet(searchTerm, Math.ceil(limit * 0.7));
    
    if (kariyerResult.success && kariyerResult.data) {
      results.jobs.push(...kariyerResult.data);
      results.sources['Kariyer.net'] = {
        success: true,
        count: kariyerResult.data.length,
        message: kariyerResult.message
      };
    } else {
      results.sources['Kariyer.net'] = {
        success: false,
        count: 0,
        message: kariyerResult.message || 'Kariyer.net scraping ba≈üarƒ±sƒ±z'
      };
    }
    
    const remainingLimit = Math.max(1, limit - results.jobs.length);
    if (remainingLimit > 0) {
      console.log(`üìã LinkedIn scraping ba≈ülatƒ±lƒ±yor (Kalan limit: ${remainingLimit})`);
      
      const linkedinResult = await scrapeLinkedIn(searchTerm, remainingLimit);
      
      if (linkedinResult.success && linkedinResult.data) {
        results.jobs.push(...linkedinResult.data);
        results.sources['LinkedIn'] = {
          success: true,
          count: linkedinResult.data.length,
          message: linkedinResult.message
        };
      } else {
        results.sources['LinkedIn'] = {
          success: false,
          count: 0,
          message: linkedinResult.message || 'LinkedIn scraping ba≈üarƒ±sƒ±z'
        };
      }
    }
    
    results.total = results.jobs.length;
    
    if (results.total > 0) {
      // Veriyi temizle ve unique yap
      const uniqueJobs = [];
      const seenTitles = new Set();
      
      results.jobs.forEach(job => {
        const titleKey = `${job.title}-${job.company}`.toLowerCase();
        if (!seenTitles.has(titleKey)) {
          seenTitles.add(titleKey);
          
          // Data cleaning ve enrichment
          job.title = job.title.replace(/\s+/g, ' ').trim();
          job.company = job.company.replace(/\s+/g, ' ').trim();
          job.location = job.location.replace(/\s+/g, ' ').trim();
          job.description = job.description.substring(0, 500).replace(/\s+/g, ' ').trim();
          
          // Anahtar kelime sistemi
          job.searchTerm = searchTerm;
          job.keywords = [searchTerm];
          
          // Ba≈ülƒ±k ve a√ßƒ±klamadan ek anahtar kelimeler √ßƒ±kar
          const extractedKeywords = extractKeywordsFromJob(job.title + ' ' + job.description);
          job.keywords = [...new Set([...job.keywords, ...extractedKeywords])];
          
          // Veritabanƒ± i√ßin uygun format
          job.jobType = 'i≈ü-ilanƒ±';
          job.isPublished = true;
          job.scraped = true;
          job.lastScrapedAt = new Date();
          
          uniqueJobs.push(job);
        }
      });
      
      results.jobs = uniqueJobs.slice(0, limit);
      results.total = results.jobs.length;
      results.message = `Toplam ${results.total} i≈ü ilanƒ± ba≈üarƒ±yla √ßekildi`;
      
      // Enhanced Database kaydetme
      try {
        console.log(`üíæ ${results.jobs.length} i≈ü ilanƒ± veritabanƒ±na kaydediliyor...`);
        
        const savedResults = [];
        let savedCount = 0;
        let updatedCount = 0;
        let errorCount = 0;
        
        for (const job of results.jobs) {
          try {
            // Aynƒ± URL varsa g√ºncelle, yoksa yeni ekle
            const existingJob = await Announcement.findOne({ url: job.url });
            
            if (existingJob) {
              // Mevcut ilanƒ± g√ºncelle
              existingJob.title = job.title;
              existingJob.company = job.company;
              existingJob.location = job.location;
              existingJob.description = job.description;
              existingJob.lastScrapedAt = new Date();
              
              // Anahtar kelimeleri birle≈ütir (duplicate olmadan)
              const combinedKeywords = [...new Set([
                ...(existingJob.keywords || []),
                ...job.keywords
              ])];
              existingJob.keywords = combinedKeywords;
              
              await existingJob.save();
              savedResults.push({ status: 'updated', job: existingJob });
              updatedCount++;
              console.log(`üîÑ G√ºncellendi: ${job.title} - ${job.company}`);
            } else {
              // Yeni ilan ekle
              const newJob = new Announcement(job);
              const saved = await newJob.save();
              savedResults.push({ status: 'created', job: saved });
              savedCount++;
              console.log(`‚úÖ Kaydedildi: ${job.title} - ${job.company}`);
            }
          } catch (saveError) {
            console.warn(`‚ö†Ô∏è ${job.title} kaydedilemedi:`, saveError.message);
            savedResults.push({ status: 'error', error: saveError.message, job: job });
            errorCount++;
          }
        }
        
        console.log(`üíæ Veritabanƒ± i≈ülemi tamamlandƒ±:`);
        console.log(`  ‚úÖ Yeni kayƒ±t: ${savedCount}`);
        console.log(`  üîÑ G√ºncellenen: ${updatedCount}`);
        console.log(`  ‚ùå Hatalƒ±: ${errorCount}`);
        
        results.database = {
          saved: savedCount,
          updated: updatedCount,
          errors: errorCount,
          total: savedCount + updatedCount
        };
        
        results.message += ` (${savedCount} yeni, ${updatedCount} g√ºncellendi)`;
        
      } catch (dbError) {
        console.error('üí• Veritabanƒ± genel hatasƒ±:', dbError);
        results.message += ' (Veritabanƒ± kaydetme hatasƒ±)';
        results.database = { error: dbError.message };
      }
      
    } else {
      results.success = false;
      results.message = 'Hi√ßbir kaynak ba≈üarƒ±lƒ± olmadƒ±';
    }
    
    console.log(`üéâ Scraping tamamlandƒ±: ${results.total} ilan`);
    return results;
    
  } catch (error) {
    console.error('‚ùå Ana scraping hatasƒ±:', error);
    return {
      success: false,
      jobs: [],
      sources: {},
      total: 0,
      message: `Scraping hatasƒ±: ${error.message}`,
      scrapedAt: new Date()
    };
  }
};

// Anahtar kelime √ßƒ±karma helper fonksiyonu
const extractKeywordsFromJob = (text) => {
  const techKeywords = [
    'react', 'vue', 'angular', 'javascript', 'typescript', 'node.js', 'nodejs',
    'python', 'java', 'c#', 'php', 'golang', 'swift', 'kotlin',
    'mongodb', 'mysql', 'postgresql', 'redis', 'elasticsearch',
    'aws', 'azure', 'gcp', 'docker', 'kubernetes', 'jenkins',
    'git', 'github', 'gitlab', 'rest', 'api', 'graphql',
    'html', 'css', 'sass', 'less', 'webpack', 'babel',
    'express', 'fastify', 'spring', 'django', 'flask',
    'frontend', 'backend', 'fullstack', 'full-stack', 'full stack',
    'mobile', 'ios', 'android', 'react native', 'flutter',
    'devops', 'sysadmin', 'linux', 'windows', 'macos',
    'sql', 'nosql', 'database', 'veritabanƒ±'
  ];
  
  const jobTypes = [
    'developer', 'geli≈ütirici', 'programcƒ±', 'yazƒ±lƒ±mcƒ±',
    'm√ºhendis', 'engineer', 'analyst', 'analist',
    'tasarƒ±mcƒ±', 'designer', 'architect', 'mimar',
    'lead', 'senior', 'junior', 'intern', 'stajyer'
  ];
  
  const allKeywords = [...techKeywords, ...jobTypes];
  const foundKeywords = [];
  const lowerText = text.toLowerCase();
  
  allKeywords.forEach(keyword => {
    if (lowerText.includes(keyword.toLowerCase())) {
      foundKeywords.push(keyword);
    }
  });
  
  return foundKeywords;
};

// Test fonksiyonlarƒ±
const testScrapeKariyer = async () => {
  console.log('üß™ Kariyer.net test ba≈ülatƒ±lƒ±yor...');
  return await scrapeKariyerNet('yazƒ±lƒ±m geli≈ütirici', 5);
};

const testScrapeLinkedIn = async () => {
  console.log('üß™ LinkedIn test ba≈ülatƒ±lƒ±yor...');
  return await scrapeLinkedIn('software developer', 3);
};

const testFullScrape = async () => {
  console.log('üß™ Full scrape test ba≈ülatƒ±lƒ±yor...');
  return await scrapeJobs('frontend developer', 8);
};

// Export fonksiyonlarƒ±
module.exports = {
  scrapeJobs,
  scrapeKariyerNet,
  scrapeLinkedIn,
  testScrapeKariyer,
  testScrapeLinkedIn,
  testFullScrape,
  executeWithRetry,
  rateLimiter,
  handleScrapingError,
  getScrapeInfo: () => {
    return {
      version: '2.0.0',
      sources: {
        'Kariyer.net': {
          active: true,
          description: 'Geli≈ümi≈ü CSS selector\'larƒ± ile T√ºrkiye\'nin en b√ºy√ºk i≈ü sitesi'
        },
        'LinkedIn': {
          active: true,
          description: 'Profesyonel network ve uluslararasƒ± i≈ü ilanlarƒ±'
        }
      },
      features: [
        'Geli≈ümi≈ü rate limiting',
        'Retry mechanism',
        'Anti-bot korumasƒ±',
        'Data cleaning',
        'Duplicate detection',
        'Real-time logging',
        'Enhanced keyword extraction',
        'Database saving with upsert'
      ],
      configuration: {
        delayBetweenRequests: '4000ms',
        maxRetries: 3,
        timeout: '45000ms',
        requestsPerMinute: 15
      }
    };
  }
}; 